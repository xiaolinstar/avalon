#!/bin/bash

# é˜¿ç“¦éš†æˆ¿é—´åŠ è½½é—®é¢˜è¯Šæ–­è„šæœ¬
# è¿™ä¸ªè„šæœ¬å¸®åŠ©è¯Šæ–­"åŠ è½½ä¸­..."é—®é¢˜çš„æ ¹æœ¬åŸå› 

echo "ğŸ® é˜¿ç“¦éš†æˆ¿é—´åŠ è½½é—®é¢˜è¯Šæ–­å·¥å…·"
echo "================================"
echo

# æ£€æŸ¥ç«¯å£å ç”¨
echo "ğŸ” æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ..."
lsof -i :8080 2>/dev/null | head -10
echo

# æ£€æŸ¥Node.jsè¿›ç¨‹
echo "ğŸ” æ£€æŸ¥Node.jsè¿›ç¨‹..."
ps aux | grep -E "(node|npm|pnpm)" | grep -v grep | head -5
echo

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
echo "ğŸ” æ£€æŸ¥æœ€è¿‘çš„æ—¥å¿—æ–‡ä»¶..."
if [ -f "backend/logs/app.log" ]; then
    echo "ğŸ“‹ åç«¯æ—¥å¿— (æœ€å10è¡Œ):"
    tail -10 backend/logs/app.log
    echo
fi

if [ -f "frontend/src/logs/debug.log" ]; then
    echo "ğŸ“‹ å‰ç«¯æ—¥å¿— (æœ€å10è¡Œ):"
    tail -10 frontend/src/logs/debug.log
    echo
fi

# æ£€æŸ¥ç½‘ç»œè¿æ¥
echo "ğŸ” æ£€æŸ¥ç½‘ç»œè¿æ¥..."
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/health 2>/dev/null || echo "âŒ åç«¯æœåŠ¡æœªå“åº”"
echo

# æ£€æŸ¥WebSocketè¿æ¥
echo "ğŸ” æ£€æŸ¥WebSocketè¿æ¥..."
node -e "
const WebSocket = require('ws');
const ws = new WebSocket('ws://localhost:8080/ws');
ws.on('open', () => {
  console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
  ws.close();
});
ws.on('error', (err) => {
  console.log('âŒ WebSocketè¿æ¥å¤±è´¥:', err.message);
});
" 2>/dev/null || echo "âŒ WebSocketæµ‹è¯•å¤±è´¥"
echo

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo "ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
if command -v psql >/dev/null 2>&1; then
    psql -h localhost -U postgres -d avalon -c "SELECT COUNT(*) FROM rooms;" 2>/dev/null || echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
else
    echo "âš ï¸ PostgreSQLå®¢æˆ·ç«¯æœªå®‰è£…ï¼Œè·³è¿‡æ•°æ®åº“æ£€æŸ¥"
fi
echo

echo "ğŸ¯ è¯Šæ–­å»ºè®®:"
echo "1. å¦‚æœçœ‹åˆ°'åŠ è½½ä¸­...'ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—"
echo "2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ (F12 -> Network)"
echo "3. éªŒè¯WebSocketè¿æ¥çŠ¶æ€"
echo "4. æ£€æŸ¥æˆ¿é—´æ•°æ®æ˜¯å¦æ­£ç¡®ä¼ é€’"
echo
echo "ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤:"
echo "- é‡å¯åç«¯: cd backend && ./mvnw spring-boot:run"
echo "- é‡å¯å‰ç«¯: cd frontend && npm run dev"
echo "- æ¸…ç†ç¼“å­˜: rm -rf frontend/node_modules/.vite"
echo "- æŸ¥çœ‹å®æ—¶æ—¥å¿—: tail -f backend/logs/app.log"
echo
echo "ğŸ“Š è°ƒè¯•å·¥å…·:"
echo "- WebSocketæµ‹è¯•: open frontend/public/websocket-debug.html"
echo "- æˆ¿é—´åŠ è½½æµ‹è¯•: open frontend/public/debug-room-loading.html"
echo "- APIæµ‹è¯•: curl http://localhost:8080/api/health"
echo
echo "ğŸ’¡ å¸¸è§é—®é¢˜:"
echo "1. useEffectæ— é™å¾ªç¯ - å·²ä¿®å¤ï¼Œæ£€æŸ¥ä¾èµ–æ•°ç»„"
echo "2. WebSocketè¿æ¥å¤±è´¥ - æ£€æŸ¥tokenå’Œç½‘ç»œ"
echo "3. æˆ¿é—´æ•°æ®ç¼ºå¤± - æ£€æŸ¥getRoomById API"
echo "4. æœ¬åœ°å­˜å‚¨é—®é¢˜ - æ¸…é™¤localStorage"